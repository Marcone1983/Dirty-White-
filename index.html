<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dirty White Sh*t</title>
<!-- TON / Telegram / EVM -->
<script src="https://unpkg.com/@tonconnect/sdk@latest"></script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/ethers@6.13.2/dist/ethers.min.js"></script>
<style>
:root{--bg:#050907;--ink:#e7fdf2;--panel:#0b0f0d;--accent:#19ff9d;--accent2:#00b3ff}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(80% 100% at 10% 10%, #06110b, #010302), url('bg.jpg');background-size:cover;background-attachment:fixed;color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1100px;margin:0 auto;padding:18px}
.header{display:flex;align-items:center;gap:14px;margin:16px 0 10px;flex-wrap:wrap}
.logo{height:58px;filter:drop-shadow(0 6px 24px #00ff9955)}
h1{margin:0;font-size:28px;line-height:1.1;white-space:normal;writing-mode:horizontal-tb;text-orientation:mixed;word-break:keep-all}
.card{background:linear-gradient(180deg,#0e1512,#080d0b);border:1px solid #0f2018;border-radius:18px;padding:18px;box-shadow:0 10px 40px #000 inset,0 8px 30px #001f1233}
.btn{background:var(--accent);color:#001b0a;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.secondary{background:#0e1612;border:1px solid #123a2a;color:#caffed}
.btn.inline{padding:8px 10px;border-radius:10px;font-size:14px}
.input,textarea{width:100%;padding:10px 12px;border-radius:12px;background:#0b130f;border:1px solid #143b2b;color:#dffdf0}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.item{background:#0a110e;border:1px solid #103726;border-radius:16px;overflow:hidden}
.item img{width:100%;height:180px;object-fit:cover}
.item .meta{padding:12px}
.badge{display:inline-block;background:#07231a;color:#9afdd7;border:1px solid #0b7a53;border-radius:10px;padding:2px 8px;font-size:12px;margin-right:6px}
.splash{position:fixed;inset:0;background:black;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:99}
.progress{width:260px;height:8px;background:#1a1a1a;border-radius:10px;overflow:hidden;margin-top:16px}
.progress>div{height:100%;background:var(--accent);animation:load 1.4s forwards}
@keyframes load{from{width:0}to{width:100%}}
.hidden{display:none}
small.muted{opacity:.72}
.status{margin-top:8px;font-size:13px}
footer{opacity:.7;margin-top:18px;font-size:12px;text-align:center}
.tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.tab{padding:8px 10px;border-radius:10px;background:#0f1713;border:1px solid #1a3a2c;cursor:pointer}
.tab.active{background:#123a2a;color:#caffed}
#connectAll{min-width:210px}
</style>
</head>
<body>

<div class="splash" id="splash">
  <img src="logo-dirtywhite.png" alt="DirtyWhite" style="width:280px;height:auto">
  <div class="progress"><div></div></div>
</div>

<!-- VETRINA -->
<div class="container hidden" id="storeApp">
  <div class="header">
    <img class="logo" src="logo-dirtywhite.png" alt="logo">
    <div>
      <h1>Dirty White Sh*t — Store</h1>
      <small class="muted">Preview 30s • Stars / TON / USDT • Instant download</small>
    </div>
    <span style="flex:1"></span>
    <button class="btn" id="connectAll">CONNECT WALLET</button>
  </div>
  <div id="heroWrap" class="card hidden" style="margin-bottom:14px">
    <img id="heroImg" src="" alt="hero" style="width:100%;max-height:260px;object-fit:cover;border-radius:12px">
  </div>
  <div id="grid" class="grid"></div>
  <div class="card" id="storeMsg" style="display:none;margin-top:12px"></div>
  <footer>Dirty White © All rights reserved</footer>
</div>

<!-- ADMIN -->
<div class="container hidden" id="adminApp">
  <div class="header">
    <img class="logo" src="logo-dirtywhite.png" alt="logo">
    <div><h1>Dirty White Sh*t — Admin</h1>
      <small class="muted">Carichi su Telegram Cloud e pinni il catalogo.</small></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Connessione Bot</h3>
    <div class="row">
      <div><label>Bot Token</label><input class="input" id="token" placeholder="123456:ABC..."></div>
      <div><label>chat_id (tuo ID o canale)</label><input class="input" id="chatid" placeholder="123456789 / -100..."></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
      <button class="btn" id="testBot">Test Bot</button>
      <button class="btn secondary" id="remember">Ricorda nel browser</button>
      <div class="status" id="botStatus"></div>
    </div>
  </div>

  <div class="tabs" style="margin-top:12px">
    <div class="tab active" data-tab="brand">Brand & Settings</div>
    <div class="tab" data-tab="track">Nuova Traccia</div>
    <div class="tab" data-tab="link">Link Pubblico</div>
  </div>

  <div class="card" id="tab-brand">
    <div class="row">
      <div><label>Background</label><input class="input" type="file" id="bg"></div>
      <div><label>Immagine Titolo (Hero)</label><input class="input" type="file" id="hero"></div>
    </div>
    <div class="row">
      <div><label>Logo</label><input class="input" type="file" id="logo"></div>
      <div>
        <label>EVM recipients (USDT)</label>
        <input class="input" id="evm1" placeholder="ETH 0x... (opzionale)" style="margin-bottom:8px">
        <input class="input" id="evm137" placeholder="Polygon 0x..." style="margin-bottom:8px">
        <input class="input" id="evm56" placeholder="BSC 0x...">
      </div>
    </div>
    <button class="btn" id="saveCfg">Salva Settings (pin catalog)</button>
    <div class="status" id="saveStatus"></div>
  </div>

  <div class="card hidden" id="tab-track">
    <h3 style="margin:0 0 8px">Nuova Traccia</h3>
    <div class="row">
      <div><label>Titolo</label><input class="input" id="title"></div>
      <div><label>Descrizione</label><input class="input" id="desc"></div>
    </div>
    <div class="row">
      <div><label>Copertina</label><input class="input" type="file" id="cover" accept="image/*"></div>
      <div><label>MP3</label><input class="input" type="file" id="mp3" accept="audio/mpeg,audio/mp3"></div>
    </div>
    <div class="row">
      <div><label>Prezzo Stars (USD equiv)</label><input class="input" type="number" id="pStars" value="3"></div>
      <div><label>Prezzo USDT / USD</label><input class="input" type="number" id="pUsdt" value="3"></div>
    </div>
    <button class="btn" id="publish">Carica & Pubblica</button>
    <div class="status" id="pubStatus"></div>
  </div>

  <div class="card hidden" id="tab-link">
    <h3 style="margin:0 0 8px">Link Pubblico</h3>
    <input class="input" id="plink" readonly>
    <button class="btn secondary" id="copy">Copia</button>
  </div>
</div>

<script>
/* ===== COSTANTI ===== */
const USDT = {1:"0xdAC17F958D2ee523a2206206994597C13D831ec7",137:"0xc2132D05D31c914a87C6611C10748aeb04B58e8F",56:"0x55d398326f99059fF775485246999027B3197955"};
let RECIPIENT_EVM = {1:null,137:null,56:null};
const TON_DEST = "UQArbhbVEIkN4xSWis30yIrNGdmOTBbiMBduGeNTErPbviyR"; // il tuo

/* ===== UTIL ===== */
const qs = id => document.getElementById(id);
const WEBAPP = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
if (WEBAPP) WEBAPP.expand();

const urlp = new URLSearchParams(location.search);
const MODE_ADMIN = urlp.get("admin")==="1";
const CHAT_QUERY = urlp.get("chat_id");

function show(id){qs(id).classList.remove('hidden')}
function hide(id){qs(id).classList.add('hidden')}
function status(el,msg,ok=true){el.textContent=(ok?'✅ ':'⚠️ ')+msg;el.style.color=ok?'#9affd9':'#ffbdbd'}

setTimeout(()=>{qs('splash').style.display='none'; MODE_ADMIN?show('adminApp'):show('storeApp')},900);

function getToken(){return localStorage.getItem('dw_token')||""}
function setToken(t){localStorage.setItem('dw_token',t)}
function getChat(){return localStorage.getItem('dw_chat')||""}
function setChat(c){localStorage.setItem('dw_chat',c)}

/* ===== Bot helpers ===== */
function fd(){return new FormData()}
async function bot(method, form){
  const tok = getToken(); if(!tok) throw new Error("Token mancante");
  const r = await fetch(`https://api.telegram.org/bot${tok}/${method}`,{method:"POST",body:form});
  const j = await r.json(); if(!j.ok) throw new Error(j.description||"Bot API error"); return j.result;
}

/* ===== Tabs Admin ===== */
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  ['brand','track','link'].forEach(id=>qs('tab-'+id).classList.toggle('hidden', id!==t.dataset.tab));
});

/* ===== Admin: connessione ===== */
qs('token').value = getToken();
qs('chatid').value = getChat() || (WEBAPP?.initDataUnsafe?.user?.id || "");
qs('testBot').onclick = async ()=>{
  try{
    const r = await fetch(`https://api.telegram.org/bot${qs('token').value.trim()}/getMe`).then(x=>x.json());
    if(r.ok){status(qs('botStatus'),`Bot ok: @${r.result.username}`)} else {status(qs('botStatus'),r.description||'Errore',false)}
  }catch(e){status(qs('botStatus'),e.message,false)}
};
qs('remember').onclick = ()=>{
  setToken(qs('token').value.trim()); setChat(qs('chatid').value.trim());
  status(qs('botStatus'),'Token e chat_id salvati nel browser');
};

/* ===== Catalog helpers ===== */
async function uploadFile(chat_id,file){
  const f=fd(); f.append('chat_id',chat_id); f.append('document',file);
  const msg=await bot('sendDocument',f);
  const gf=fd(); gf.append('file_id',msg.document.file_id);
  const g=await bot('getFile',gf);
  return {file_id:msg.document.file_id,url:`https://api.telegram.org/file/bot${getToken()}/`+g.file_path};
}
async function getCatalog(chat_id){
  try{
    const f=fd(); f.append('chat_id',chat_id);
    const chat=await bot('getChat',f);
    if(chat.pinned_message?.document){
      const g=fd(); g.append('file_id',chat.pinned_message.document.file_id);
      const file=await bot('getFile',g);
      const url=`https://api.telegram.org/file/bot${getToken()}/`+file.file_path;
      return await (await fetch(url)).json();
    }
  }catch(e){}
  return {tracks:[],recipients:{1:null,137:null,56:null}};
}
async function publishCatalog(chat_id, catalog){
  const blob=new Blob([JSON.stringify(catalog,null,2)],{type:'application/json'});
  const f=fd(); f.append('chat_id',chat_id); f.append('document',blob,'catalog.json'); f.append('caption','#CATALOG');
  const msg=await bot('sendDocument',f);
  const pin=fd(); pin.append('chat_id',chat_id); pin.append('message_id',msg.message_id); pin.append('disable_notification','true');
  await bot('pinChatMessage',pin);
  return msg;
}

/* ===== Admin: Salva Settings ===== */
qs('saveCfg').onclick = async ()=>{
  try{
    const tok=qs('token').value.trim(), chat=qs('chatid').value.trim();
    if(!tok||!chat) return status(qs('saveStatus'),'Inserisci token e chat_id',false);
    setToken(tok); setChat(chat);
    let cat=await getCatalog(chat);
    cat.recipients={1:qs('evm1').value||null,137:qs('evm137').value||null,56:qs('evm56').value||null};
    const bg=qs('bg').files[0], hero=qs('hero').files[0], logo=qs('logo').files[0];
    if(bg)   cat.bg  =(await uploadFile(chat,bg)).url;
    if(hero) cat.hero=(await uploadFile(chat,hero)).url;
    if(logo) cat.logo=(await uploadFile(chat,logo)).url;
    await publishCatalog(chat,cat);
    status(qs('saveStatus'),'Settings salvati & catalogo pinnato');
    const pub = new URL(location.href); pub.search = '?chat_id='+encodeURIComponent(chat);
    qs('plink').value = pub.toString();
  }catch(e){status(qs('saveStatus'),e.message,false)}
};

/* ===== Admin: Pubblica Traccia ===== */
qs('publish').onclick = async ()=>{
  try{
    const chat=getChat(); if(!chat) return status(qs('pubStatus'),'Prima salva token e chat_id',false);
    const title=qs('title').value, desc=qs('desc').value, cover=qs('cover').files[0], mp3=qs('mp3').files[0];
    const pStars=Number(qs('pStars').value||0), pUsdt=Number(qs('pUsdt').value||0);
    if(!title||!cover||!mp3) return status(qs('pubStatus'),'Titolo/cover/MP3 obbligatori',false);
    const coverUp=await uploadFile(chat,cover); const mp3Up=await uploadFile(chat,mp3);
    let cat=await getCatalog(chat); cat.tracks=cat.tracks||[];
    const id='t'+Date.now();
    cat.tracks.unshift({id,title,description:desc,cover_file_id:coverUp.file_id,cover_url:coverUp.url,file_file_id:mp3Up.file_id,file_url:mp3Up.url,prices:{stars:pStars,usdt:pUsdt,usd:pUsdt,ton:pUsdt}});
    await publishCatalog(chat,cat);
    status(qs('pubStatus'),'Traccia pubblicata & catalogo aggiornato');
    const pub = new URL(location.href); pub.search='?chat_id='+encodeURIComponent(chat);
    qs('plink').value = pub.toString();
    // switch automatico al tab Link
    document.querySelector('.tab[data-tab="link"]').click();
  }catch(e){status(qs('pubStatus'),e.message,false)}
};

/* ===== Admin: Link pubblico copy ===== */
qs('copy').onclick=()=>{qs('plink').select();document.execCommand('copy')};

/* ===== Vetrina ===== */
async function renderStore(chat_id){
  try{
    const cat=await getCatalog(chat_id);
    if(cat.logo) document.querySelectorAll('.logo').forEach(i=>i.src=cat.logo);
    if(cat.bg) document.body.style.backgroundImage=`url('${cat.bg}')`;
    if(cat.hero){qs('heroWrap').classList.remove('hidden');qs('heroImg').src=cat.hero}
    RECIPIENT_EVM=cat.recipients||RECIPIENT_EVM;

    const grid=qs('grid'); grid.innerHTML='';
    if(!cat.tracks||!cat.tracks.length){qs('storeMsg').style.display='block';qs('storeMsg').textContent='Nessuna traccia pubblicata.';return;}
    cat.tracks.forEach((t,i)=>{
      const card=document.createElement('div'); card.className='item';
      const img=document.createElement('img'); img.src=t.cover_url;
      const meta=document.createElement('div'); meta.className='meta';
      const title=document.createElement('div'); title.innerHTML=`<strong>${t.title}</strong>`;
      const prices=document.createElement('div'); prices.innerHTML=`<span class="badge">Stars: $${t.prices.stars}</span><span class="badge">USDT: $${t.prices.usdt}</span><span class="badge">USD: $${t.prices.usd}</span>`;
      const audio=document.createElement('audio'); audio.controls=true; audio.src=t.file_url;
      audio.addEventListener('timeupdate',()=>{if(!audio.dataset.unlocked && audio.currentTime>30){audio.pause();audio.currentTime=0;alert('Preview 30s')}})
      const row=document.createElement('div'); row.style.marginTop='8px';
      const bS=document.createElement('button'); bS.className='btn'; bS.textContent='Buy Stars'; bS.onclick=()=>payStars(t,i);
      const bT=document.createElement('button'); bT.className='btn secondary'; bT.textContent='Buy TON'; bT.style.marginLeft='6px'; bT.onclick=()=>payTon(t,i);
      const bU=document.createElement('button'); bU.className='btn secondary'; bU.textContent='Buy USDT'; bU.style.marginLeft='6px'; bU.onclick=()=>payUSDT(t,i);
      const dl=document.createElement('a'); dl.id='dl'+i; dl.textContent='Download'; dl.className='btn'; dl.style.display='none'; dl.href=t.file_url; dl.download=(t.title||'track')+'.mp3'; dl.style.marginLeft='6px';
      row.append(bS,bT,bU,dl); meta.append(title,prices,audio,row); card.append(img,meta); grid.append(card);
    });
  }catch(e){qs('storeMsg').style.display='block';qs('storeMsg').textContent=e.message}
}
function unlock(i){const a=qs('dl'+i); if(a) a.style.display='inline-block'}

/* Wallet connect combo */
const tonConnector=new TON_CONNECT.TonConnect();
qs('connectAll').onclick=async()=>{ try{ if(!tonConnector.connected) await tonConnector.connectWallet(); if(window.ethereum) await window.ethereum.request({method:'eth_requestAccounts'});}catch{} };

let evmProvider=null, evmSigner=null, evmChain=null;
if(window.ethereum){ (async ()=>{ try{ await window.ethereum.request({method:'eth_requestAccounts'}); evmProvider=new ethers.BrowserProvider(window.ethereum); evmSigner=await evmProvider.getSigner(); evmChain=(await evmProvider.getNetwork()).chainId; }catch{} })(); }

/* Pagamenti */
async function payTon(t,i){
  if(!tonConnector.connected) await tonConnector.connectWallet();
  const amountNano=BigInt(Math.round((t.prices.ton||t.prices.usdt)*1e9));
  await tonConnector.sendTransaction({validUntil:Math.floor(Date.now()/1000)+360,messages:[{address:TON_DEST,amount:String(amountNano)}]});
  alert('TON inviato. Download sbloccato.'); unlock(i);
}
async function payUSDT(t,i){
  if(!evmSigner){alert('Connetti un wallet EVM');return}
  const chainId=Number(evmChain), token=USDT[chainId], to=(RECIPIENT_EVM&&RECIPIENT_EVM[chainId])||null;
  if(!token||!to){alert('USDT non configurato per questa chain');return}
  const abi=["function transfer(address to,uint value) returns(bool)","function decimals() view returns(uint8)"];
  const c=new ethers.Contract(token,abi,evmSigner); const dec=await c.decimals();
  const amount=BigInt(Math.round((t.prices.usdt||0)* (10**Number(dec))));
  const tx=await c.transfer(to,amount); await tx.wait(); alert('USDT pagato.'); unlock(i);
}
async function payStars(t,i){
  if(!(window.Telegram&&Telegram.WebApp)){alert('Apri in Telegram per pagare con Stars');return}
  const P=fd(); P.append('title',t.title); P.append('description',t.description||''); P.append('payload','stars:'+t.id); P.append('currency','XTR');
  P.append('prices',JSON.stringify([{label:'Track',amount:Math.round((t.prices.stars||0)*100)}]));
  const tok=getToken(); const resp=await fetch(`https://api.telegram.org/bot${tok}/createInvoiceLink`,{method:'POST',body:P}).then(r=>r.json());
  if(!resp.ok){alert('Stars non configurate sul bot');return}
  Telegram.WebApp.openInvoice(resp.result,(status)=>{if(status==='paid'){alert('Pagato');unlock(i)}})
}

/* Boot vetrina */
if(!MODE_ADMIN){
  const cid = CHAT_QUERY;
  if(!cid){qs('storeMsg').style.display='block';qs('storeMsg').textContent='Aggiungi ?chat_id=... all’URL (lo trovi nell’admin)';}
  else {renderStore(cid)}
}
</script>
</body>
</html>
