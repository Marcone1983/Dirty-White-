<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Dirty White Sh*t</title>
<!-- Telegram WebApp, EVM, TonConnect UI -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/ethers@6.13.2/dist/ethers.min.js"></script>
<script src="https://unpkg.com/@tonconnect/ui@latest"></script>
<style>
:root{--bg:#050907;--ink:#e7fdf2;--panel:#0b0f0d;--accent:#19ff9d}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(80% 100% at 10% 10%, #06110b, #010302), url('bg.jpg');background-size:cover;background-attachment:fixed;color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1100px;margin:0 auto;padding:18px}
.header{display:flex;align-items:center;gap:14px;margin:16px 0 10px;flex-wrap:wrap}
.logo{height:58px;filter:drop-shadow(0 6px 24px #00ff9955)}
h1{margin:0;font-size:28px;line-height:1.1;writing-mode:horizontal-tb;text-orientation:mixed}
.card{background:linear-gradient(180deg,#0e1512,#080d0b);border:1px solid #0f2018;border-radius:18px;padding:18px;box-shadow:0 10px 40px #000 inset,0 8px 30px #001f1233}
.btn{background:var(--accent);color:#001b0a;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.secondary{background:#0e1612;border:1px solid #123a2a;color:#caffed}
.input,textarea{width:100%;padding:10px 12px;border-radius:12px;background:#0b130f;border:1px solid #143b2b;color:#dffdf0}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.item{background:#0a110e;border:1px solid #103726;border-radius:16px;overflow:hidden}
.item img{width:100%;height:180px;object-fit:cover}
.item .meta{padding:12px}
.badge{display:inline-block;background:#07231a;color:#9afdd7;border:1px solid #0b7a53;border-radius:10px;padding:2px 8px;font-size:12px;margin-right:6px}
.splash{position:fixed;inset:0;background:black;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:99}
.progress{width:260px;height:8px;background:#1a1a1a;border-radius:10px;overflow:hidden;margin-top:16px}
.progress>div{height:100%;background:var(--accent);animation:load 1.1s forwards}
@keyframes load{from{width:0}to{width:100%}}
.hidden{display:none}
small.muted{opacity:.72}
.status{margin-top:8px;font-size:13px}
footer{opacity:.7;margin-top:18px;font-size:12px;text-align:center}
.tabs{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.tab{padding:8px 10px;border-radius:10px;background:#0f1713;border:1px solid #1a3a2c;cursor:pointer}
.tab.active{background:#123a2a;color:#caffed}
.kv{display:grid;grid-template-columns:170px 1fr;gap:8px;align-items:center}
.badge.ok{background:#07231a;border-color:#0b7a53;color:#9afdd7}
.badge.err{background:#231007;border-color:#7a0b2a;color:#ffd0d8}
#connectAll{min-width:210px}
</style>
</head>
<body>

<div class="splash" id="splash">
  <img src="logo-dirtywhite.png" alt="DirtyWhite" style="width:280px;height:auto">
  <div class="progress"><div></div></div>
</div>

<!-- VETRINA -->
<div class="container hidden" id="storeApp">
  <div class="header">
    <img class="logo" src="logo-dirtywhite.png" alt="logo">
    <div>
      <h1>Dirty White Sh*t — Store</h1>
      <small class="muted">Preview 30s • Stars / TON / USDT • Instant download (verificato)</small>
    </div>
    <span style="flex:1"></span>
    <button class="btn" id="connectAll">CONNECT WALLET</button>
  </div>
  <div id="heroWrap" class="card hidden" style="margin-bottom:14px">
    <img id="heroImg" src="" alt="hero" style="width:100%;max-height:260px;object-fit:cover;border-radius:12px">
  </div>
  <div id="grid" class="grid"></div>
  <div class="card" id="storeMsg" style="display:none;margin-top:12px"></div>
  <footer>Dirty White © All rights reserved</footer>
</div>

<!-- ADMIN -->
<div class="container hidden" id="adminApp">
  <div class="header">
    <img class="logo" src="logo-dirtywhite.png" alt="logo">
    <div><h1>Dirty White Sh*t — Admin</h1>
      <small class="muted">Telegram Cloud backend • Verifica Stars (bot) • Verifica TON (on-chain)</small></div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Connessione Bot</h3>
    <div class="row">
      <div><label>Bot Token</label><input class="input" id="token" placeholder="123456:ABC..."></div>
      <div><label>chat_id (tuo ID o canale)</label><input class="input" id="chatid" placeholder="123456789 / -100..."></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
      <button class="btn" id="testBot">Test Bot</button>
      <button class="btn secondary" id="remember">Ricorda nel browser</button>
      <div class="status" id="botStatus"></div>
    </div>
  </div>

  <div class="tabs" style="margin-top:12px">
    <div class="tab active" data-tab="brand">Brand & Settings</div>
    <div class="tab" data-tab="track">Nuova Traccia</div>
    <div class="tab" data-tab="pay">Pagamenti / Verifica</div>
    <div class="tab" data-tab="link">Link Pubblico</div>
  </div>

  <div class="card" id="tab-brand">
    <div class="row">
      <div><label>Background</label><input class="input" type="file" id="bg"></div>
      <div><label>Immagine Titolo (Hero)</label><input class="input" type="file" id="hero"></div>
    </div>
    <div class="row">
      <div><label>Logo</label><input class="input" type="file" id="logo"></div>
      <div>
        <label>EVM recipients (USDT)</label>
        <input class="input" id="evm1" placeholder="ETH 0x... (opzionale)" style="margin-bottom:8px">
        <input class="input" id="evm137" placeholder="Polygon 0x..." style="margin-bottom:8px">
        <input class="input" id="evm56" placeholder="BSC 0x...">
      </div>
    </div>
    <button class="btn" id="saveCfg">Salva Settings (pin catalog)</button>
    <div class="status" id="saveStatus"></div>
  </div>

  <div class="card hidden" id="tab-track">
    <h3 style="margin:0 0 8px">Nuova Traccia</h3>
    <div class="row">
      <div><label>Titolo</label><input class="input" id="title"></div>
      <div><label>Descrizione</label><input class="input" id="desc"></div>
    </div>
    <div class="row">
      <div><label>Copertina</label><input class="input" type="file" id="cover" accept="image/*"></div>
      <div><label>MP3</label><input class="input" type="file" id="mp3" accept="audio/mpeg,audio/mp3"></div>
    </div>
    <div class="row">
      <div><label>Prezzo Stars (XTR)</label><input class="input" type="number" id="pStars" value="3" step="1" min="1"></div>
      <div><label>Prezzo USDT (USD)</label><input class="input" type="number" id="pUsdt" value="3" step="0.01" min="0"></div>
    </div>
    <div class="row">
      <div><label>Prezzo TON (TON)</label><input class="input" type="number" id="pTon" value="0.5" step="0.000000001" min="0"></div>
      <div></div>
    </div>
    <button class="btn" id="publish">Carica & Pubblica</button>
    <div class="status" id="pubStatus"></div>
  </div>

  <div class="card hidden" id="tab-pay">
    <h3 style="margin:0 0 8px">Verifica Pagamenti</h3>
    <div class="kv"><div>Webhook Bot</div><div><span id="whStatus" class="badge">—</span></div></div>
    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
      <button class="btn" id="checkWebhook">Controlla Webhook</button>
      <button class="btn secondary" id="enablePolling">Abilita Polling (DeleteWebhook)</button>
    </div>
    <div class="status" id="payStatus"></div>
    <small class="muted">La verifica **Stars** usa <code>getUpdates</code> (serve webhook disattivo). La verifica **TON** usa TonConnect + polling on-chain pubblico.</small>
  </div>

  <div class="card hidden" id="tab-link">
    <h3 style="margin:0 0 8px">Link Pubblico</h3>
    <input class="input" id="plink" readonly>
    <button class="btn secondary" id="copy">Copia</button>
    <div class="status" id="alinkWrap" style="margin-top:8px">
      <div style="font-size:12px;opacity:.8">Admin link (ripristina token+chat dal #):</div>
      <input class="input" id="alink" readonly>
    </div>
  </div>
</div>

<script>
/* ====== COSTANTI / CONFIG ====== */
const USDT = {1:"0xdAC17F958D2ee523a2206206994597C13D831ec7",137:"0xc2132D05D31c914a87C6611C10748aeb04B58e8F",56:"0x55d398326f99059fF775485246999027B3197955"};
let RECIPIENT_EVM = {1:null,137:null,56:null};
const TON_DEST = "UQArbhbVEIkN4xSWis30yIrNGdmOTBbiMBduGeNTErPbviyR"; // tuo TON
const BASE = location.origin + location.pathname.replace(/index\.html$/,'');
const MANIFEST_URL = BASE + 'tonconnect-manifest.json';

/* ====== UTIL / STATE ====== */
const qs = id => document.getElementById(id);
const WEBAPP = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
if (WEBAPP) WEBAPP.expand();
const urlp = new URLSearchParams(location.search);
const MODE_ADMIN = urlp.get("admin")==="1";
const CHAT_QUERY = urlp.get("chat_id");
function show(id){qs(id).classList.remove('hidden')}
function status(el,msg,ok=true){el.textContent=(ok?'✅ ':'⚠️ ')+msg;el.style.color=ok?'#9affd9':'#ffbdbd'}
setTimeout(()=>{qs('splash').style.display='none'; MODE_ADMIN?show('adminApp'):show('storeApp'); if(MODE_ADMIN) updateLinksUI();},800);

/* Persistenza credenziali */
function setToken(v){localStorage.setItem('dw_token',v); sessionStorage.setItem('dw_token',v);}
function getToken(){return localStorage.getItem('dw_token')||sessionStorage.getItem('dw_token')||""}
function setChat(v){localStorage.setItem('dw_chat',v); sessionStorage.setItem('dw_chat',v);}
function getChat(){return localStorage.getItem('dw_chat')||sessionStorage.getItem('dw_chat')||""}
/* Import da hash #<b64(token)>|<chat_id> */
(function readHash(){
  if(location.hash && location.hash.length>1){
    try{const raw=decodeURIComponent(location.hash.slice(1)); const [b64,chat]=raw.split("|"); if(b64&&chat){const tok=atob(b64); if(tok.includes(":")){setToken(tok); setChat(chat);}}}catch(e){}
  }
})();

/* ====== Bot helpers ====== */
function fd(){return new FormData()}
async function bot(method, form){
  const tok=getToken(); if(!tok) throw new Error("Token mancante");
  const r=await fetch(`https://api.telegram.org/bot${tok}/${method}`,{method:"POST",body:form});
  const j=await r.json(); if(!j.ok) throw new Error(j.description||"Bot API error"); return j.result;
}

/* ====== Tabs ====== */
document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  ['brand','track','pay','link'].forEach(id=>qs('tab-'+id).classList.toggle('hidden', id!==t.dataset.tab));
});

/* ====== Admin: connessione ====== */
qs('token').value = getToken();
qs('chatid').value = getChat() || (WEBAPP?.initDataUnsafe?.user?.id || "");
qs('testBot').onclick = async ()=>{
  try{const r=await fetch(`https://api.telegram.org/bot${qs('token').value.trim()}/getMe`).then(x=>x.json());
      if(r.ok){status(qs('botStatus'),`Bot ok: @${r.result.username}`)} else {status(qs('botStatus'),r.description||'Errore',false)}
  }catch(e){status(qs('botStatus'),e.message,false)}
};
qs('remember').onclick = ()=>{
  const tok=qs('token').value.trim(), chat=qs('chatid').value.trim();
  setToken(tok); setChat(chat);
  status(qs('botStatus'),'Token e chat_id salvati nel browser'); updateLinksUI();
};

/* ====== Catalog ====== */
async function uploadFile(chat_id,file){
  const f=fd(); f.append('chat_id',chat_id); f.append('document',file);
  const msg=await bot('sendDocument',f);
  const gf=fd(); gf.append('file_id',msg.document.file_id);
  const g=await bot('getFile',gf);
  return {file_id:msg.document.file_id,url:`https://api.telegram.org/file/bot${getToken()}/`+g.file_path};
}
async function getCatalog(chat_id){
  try{
    const f=fd(); f.append('chat_id',chat_id);
    const chat=await bot('getChat',f);
    if(chat.pinned_message?.document){
      const g=fd(); g.append('file_id',chat.pinned_message.document.file_id);
      const file=await bot('getFile',g);
      const url=`https://api.telegram.org/file/bot${getToken()}/`+file.file_path;
      return await (await fetch(url)).json();
    }
  }catch(e){}
  return {tracks:[],recipients:{1:null,137:null,56:null}};
}
async function publishCatalog(chat_id, catalog){
  const blob=new Blob([JSON.stringify(catalog,null,2)],{type:'application/json'});
  const f=fd(); f.append('chat_id',chat_id); f.append('document',blob,'catalog.json'); f.append('caption','#CATALOG');
  const msg=await bot('sendDocument',f);
  const pin=fd(); pin.append('chat_id',chat_id); pin.append('message_id',msg.message_id); pin.append('disable_notification','true');
  await bot('pinChatMessage',pin); return msg;
}

/* ====== Link builders ====== */
function publicLinkOf(chat){ const u=new URL(location.href); u.search='?chat_id='+encodeURIComponent(chat); u.hash=''; return u.toString(); }
function adminLinkWithCreds(){ const tok=getToken(), chat=getChat(); if(!tok||!chat) return ''; const b64=btoa(tok); const u=new URL(location.href); u.search='?admin=1'; u.hash=encodeURIComponent(b64+'|'+chat); return u.toString(); }
function updateLinksUI(){ const chat=getChat(); if(qs('plink')) qs('plink').value = chat ? publicLinkOf(chat) : ''; if(qs('alink')) qs('alink').value = (getToken() && chat) ? adminLinkWithCreds() : ''; }

/* ====== Admin: salva settings ====== */
qs('saveCfg').onclick = async ()=>{
  try{
    const tok=qs('token').value.trim(), chat=qs('chatid').value.trim();
    if(!tok||!chat) return status(qs('saveStatus'),'Inserisci token e chat_id',false);
    setToken(tok); setChat(chat);
    let cat=await getCatalog(chat);
    cat.recipients={1:qs('evm1').value||null,137:qs('evm137').value||null,56:qs('evm56').value||null};
    const bg=qs('bg').files[0], hero=qs('hero').files[0], logo=qs('logo').files[0];
    if(bg)   cat.bg  =(await uploadFile(chat,bg)).url;
    if(hero) cat.hero=(await uploadFile(chat,hero)).url;
    if(logo) cat.logo=(await uploadFile(chat,logo)).url;
    await publishCatalog(chat,cat);
    status(qs('saveStatus'),'Settings salvati & catalogo pinnato'); updateLinksUI();
    document.querySelector('.tab[data-tab="link"]').click();
  }catch(e){status(qs('saveStatus'),e.message,false)}
};

/* ====== Admin: pubblica traccia ====== */
qs('publish').onclick = async ()=>{
  try{
    const chat=getChat(); if(!chat) return status(qs('pubStatus'),'Prima salva token e chat_id',false);
    const title=qs('title').value, desc=qs('desc').value, cover=qs('cover').files[0], mp3=qs('mp3').files[0];
    const pStars=Number(qs('pStars').value||0), pUsdt=Number(qs('pUsdt').value||0), pTon=Number(qs('pTon').value||0);
    if(!title||!cover||!mp3) return status(qs('pubStatus'),'Titolo/cover/MP3 obbligatori',false);
    const coverUp=await uploadFile(chat,cover); const mp3Up=await uploadFile(chat,mp3);
    let cat=await getCatalog(chat); cat.tracks=cat.tracks||[];
    const id='t'+Date.now();
    cat.tracks.unshift({id,title,description:desc,cover_file_id:coverUp.file_id,cover_url:coverUp.url,file_file_id:mp3Up.file_id,file_url:mp3Up.url,prices:{stars:pStars,usdt:pUsdt,usd:pUsdt,ton:pTon}});
    await publishCatalog(chat,cat);
    status(qs('pubStatus'),'Traccia pubblicata & catalogo aggiornato'); updateLinksUI();
    document.querySelector('.tab[data-tab="link"]').click();
  }catch(e){status(qs('pubStatus'),e.message,false)}
};
qs('copy').onclick=()=>{qs('plink').select();document.execCommand('copy')};

/* ====== Admin: webhook tools (Stars polling) ====== */
qs('checkWebhook').onclick = async ()=>{
  try{
    const tok=qs('token').value.trim(); if(!tok) return status(qs('payStatus'),'Metti il token prima',false);
    const r=await fetch(`https://api.telegram.org/bot${tok}/getWebhookInfo`).then(x=>x.json());
    if(r.ok && r.result.url){ qs('whStatus').className='badge err'; qs('whStatus').textContent='Webhook ATTIVO: '+r.result.url; }
    else { qs('whStatus').className='badge ok'; qs('whStatus').textContent='Webhook assente (OK per polling)'; }
  }catch(e){ status(qs('payStatus'), e.message, false); }
};
qs('enablePolling').onclick = async ()=>{
  try{
    const tok=qs('token').value.trim(); if(!tok) return status(qs('payStatus'),'Metti il token prima',false);
    const r=await fetch(`https://api.telegram.org/bot${tok}/deleteWebhook`,{method:'POST'}).then(x=>x.json());
    if(r.ok){ qs('whStatus').className='badge ok'; qs('whStatus').textContent='Webhook rimosso: OK polling'; status(qs('payStatus'),'Polling abilitato'); }
    else { status(qs('payStatus'), r.description||'Errore deleteWebhook', false); }
  }catch(e){ status(qs('payStatus'), e.message, false); }
};

/* ====== Helpers ====== */
function priceToUnits(amount, decimals){
  const s=String(amount||0);
  if(!s.includes(".")) return BigInt(s)*(10n**BigInt(decimals));
  const [i,f]=s.split("."); const frac=(f+"0".repeat(decimals)).slice(0,decimals);
  return BigInt(i||"0")*(10n**BigInt(decimals)) + BigInt(frac||"0");
}
function uid(){return Date.now().toString(36)+Math.random().toString(36).slice(2,8)}
function getUserId(){return WEBAPP?.initDataUnsafe?.user?.id || null}

/* ====== TonConnect setup ====== */
const tonUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: MANIFEST_URL });
async function ensureTonConnected(){ if(!tonUI.connected){ await tonUI.connectWallet(); } return tonUI.account?.address || null; }

/* ====== Vetrina ====== */
async function renderStore(chat_id){
  try{
    const cat=await getCatalog(chat_id);
    if(cat.logo) document.querySelectorAll('.logo').forEach(i=>i.src=cat.logo);
    if(cat.bg) document.body.style.backgroundImage=`url('${cat.bg}')`;
    if(cat.hero){qs('heroWrap').classList.remove('hidden');qs('heroImg').src=cat.hero}
    RECIPIENT_EVM=cat.recipients||RECIPIENT_EVM;

    const grid=qs('grid'); grid.innerHTML='';
    if(!cat.tracks||!cat.tracks.length){qs('storeMsg').style.display='block';qs('storeMsg').textContent='Nessuna traccia pubblicata.';return;}
    cat.tracks.forEach((t,i)=>{
      const card=document.createElement('div'); card.className='item';
      const img=document.createElement('img'); img.src=t.cover_url;
      const meta=document.createElement('div'); meta.className='meta';
      const title=document.createElement('div'); title.innerHTML=`<strong>${t.title}</strong>`;
      const prices=document.createElement('div'); prices.innerHTML=`<span class="badge">Stars: ${t.prices.stars}</span><span class="badge">USDT: $${t.prices.usdt}</span><span class="badge">TON: ${t.prices.ton}</span>`;
      const audio=document.createElement('audio'); audio.controls=true; audio.src=t.file_url; audio.preload="metadata";
      audio.addEventListener('timeupdate',()=>{ if(!audio.dataset.unlocked && audio.currentTime>29.8){ audio.pause(); audio.currentTime=0; alert('Preview 30s'); }})
      const row=document.createElement('div'); row.style.marginTop='8px';
      const bS=document.createElement('button'); bS.className='btn'; bS.textContent='Buy Stars (verificato)'; bS.onclick=()=>payStars(t,i);
      const bT=document.createElement('button'); bT.className='btn secondary'; bT.textContent='Buy TON (verificato)'; bT.style.marginLeft='6px'; bT.onclick=()=>payTon(t,i);
      const bU=document.createElement('button'); bU.className='btn secondary'; bU.textContent='Buy USDT (verificato)'; bU.style.marginLeft='6px'; bU.onclick=()=>payUSDT(t,i);
      const dl=document.createElement('a'); dl.id='dl'+i; dl.textContent='Download'; dl.className='btn'; dl.style.display='none'; dl.href=t.file_url; dl.download=(t.title||'track')+'.mp3'; dl.style.marginLeft='6px';
      row.append(bS,bT,bU,dl); meta.append(title,prices,audio,row); card.append(img,meta); grid.append(card);
    });
  }catch(e){qs('storeMsg').style.display='block';qs('storeMsg').textContent=e.message}
}
function unlock(i){const a=qs('dl'+i); if(a){ a.style.display='inline-block'; const au=a.parentElement.previousSibling; if(au && au.tagName==='AUDIO'){ au.dataset.unlocked='1'; }}}

/* ====== CONNECT WALLET ====== */
qs('connectAll').onclick=async()=>{
  // TON
  try{ await ensureTonConnected(); }catch(e){ alert('Connetti TON dal popup TonConnect.'); }
  // EVM
  try{ if(window.ethereum){ await window.ethereum.request({method:'eth_requestAccounts'});} }catch(e){}
  alert('Wallet collegati. Puoi acquistare con Stars / TON / USDT.');
};

/* ====== Pagamenti ====== */
let evmProvider=null, evmSigner=null, evmChain=null;
if(window.ethereum){ (async ()=>{ try{ await window.ethereum.request({method:'eth_requestAccounts'}); evmProvider=new ethers.BrowserProvider(window.ethereum); evmSigner=await evmProvider.getSigner(); evmChain=(await evmProvider.getNetwork()).chainId; }catch{} })(); }

/* STARS — verifica reale via polling getUpdates */
async function payStars(t,i){
  if(!(window.Telegram&&Telegram.WebApp)){alert('Apri in Telegram (WebApp) per pagare con Stars');return}
  const chat=getChat(); if(!chat){alert('Config mancante: chat_id');return}
  const user=getUserId(); if(!user){alert('Apri dentro Telegram per associare il tuo user');return}

  // Payload univoco
  const nonce=uid(); const payload=`stars:${t.id}:${nonce}`;
  const P=new FormData();
  P.append('title',t.title); P.append('description',t.description||''); P.append('payload',payload);
  P.append('currency','XTR'); P.append('prices', JSON.stringify([{label:'Track', amount: Math.round(Number(t.prices.stars||0))}]));
  const tok=getToken(); const inv=await fetch(`https://api.telegram.org/bot${tok}/createInvoiceLink`,{method:'POST',body:P}).then(r=>r.json());
  if(!inv.ok){alert('Stars non configurate sul bot');return}

  // Polling getUpdates (richiede webhook disattivo)
  let stop=false; const startTs=Date.now();
  let offset=Number(localStorage.getItem('dw_upd_offset')||0);
  (async function poll(){
    while(!stop){
      try{
        const b=new URLSearchParams(); if(offset>0) b.set('offset',String(offset)); b.set('timeout','20');
        const up=await fetch(`https://api.telegram.org/bot${tok}/getUpdates`,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:b}).then(r=>r.json());
        if(up.ok){
          for(const u of up.result){
            offset=u.update_id+1;
            const m=u.message;
            if(m && m.successful_payment){
              const sp=m.successful_payment;
              if(sp.invoice_payload===payload && String(m.from.id)===String(user)){
                stop=true; localStorage.setItem('dw_upd_offset', String(offset));
                alert('Pagamento Stars verificato ✅'); unlock(i); return;
              }
            }
          }
          localStorage.setItem('dw_upd_offset', String(offset));
        }else{
          if((up.description||'').toLowerCase().includes('webhook')){ alert('Webhook attivo: Admin → Pagamenti → Abilita Polling'); stop=true; return; }
        }
      }catch(e){ /* rete: riprova */ }
    }
  })();

  Telegram.WebApp.openInvoice(inv.result,(status)=>{ if(status==='failed'){ stop=true; alert('Pagamento annullato'); } });
}

/* TON — TonConnect + verifica on-chain */
async function payTon(t,i){
  try{
    const addrFrom = await ensureTonConnected(); if(!addrFrom){alert('Wallet TON non connesso');return}
    const priceTon = Number(t.prices.ton||0);
    const amountNano = String(Number.isFinite(priceTon) ? Math.round(priceTon*1e9) : 0);
    const validUntil = Math.floor(Date.now()/1000)+600;

    await tonUI.sendTransaction({ validUntil, messages:[{address:TON_DEST, amount:amountNano}] });

    // Poll on-chain: cerco una tx in uscita da addrFrom → TON_DEST con importo == amountNano
    const ok = await verifyTonOnChain(addrFrom, TON_DEST, BigInt(amountNano), Date.now());
    if(ok){ alert('Pagamento TON verificato ✅'); unlock(i); }
    else { alert('Non ho trovato la transazione TON (ritenta o attendi e ricarica)'); }
  }catch(e){ alert('TON: '+(e?.message||e)); }
}

// Verifica TON: TonAPI → fallback Toncenter
async function verifyTonOnChain(fromAddr, toAddr, amountNano, startMs){
  const timeoutMs=120000, pollEvery=4000; // 2 minuti max
  const until=Date.now()+timeoutMs;
  // normalizza indirizzi (tolgo spazi)
  fromAddr=String(fromAddr).trim(); toAddr=String(toAddr).trim();

  async function tryTonApi(){
    const url=`https://tonapi.io/v2/address/${encodeURIComponent(fromAddr)}/transactions?limit=20`;
    const r=await fetch(url); if(!r.ok) throw new Error('tonapi status '+r.status);
    const j=await r.json();
    const txs = j.transactions || j || [];
    for(const tx of txs){
      const outs = tx.out_msgs || tx.outMsgs || tx.messages || [];
      for(const m of outs){
        const dest = (m.destination || m.dst || m.address || "").trim();
        const val = BigInt(m.value || m.amount || m.nano || 0);
        const ts  = (tx.utime || tx.now || tx.timestamp || 0)*1000;
        if(dest && toAddr && eqAddr(dest,toAddr) && val===amountNano && ts>=startMs-15000) return true;
      }
    }
    return false;
  }
  async function tryToncenter(){
    const url=`https://toncenter.com/api/v2/getTransactions?address=${encodeURIComponent(fromAddr)}&limit=20`;
    const r=await fetch(url); if(!r.ok) throw new Error('toncenter status '+r.status);
    const j=await r.json(); const txs=j.result||[];
    for(const tx of txs){
      const outs = tx.out_msgs || [];
      for(const m of outs){
        const dest=(m.destination||"").trim();
        const val = BigInt(m.value||0);
        const ts  = (tx.utime||0)*1000;
        if(dest && toAddr && eqAddr(dest,toAddr) && val===amountNano && ts>=startMs-15000) return true;
      }
    }
    return false;
  }
  function eqAddr(a,b){ return a.replace(/[^A-Za-z0-9:_-]/g,'')===b.replace(/[^A-Za-z0-9:_-]/g,''); }

  while(Date.now()<until){
    try{ if(await tryTonApi()) return true; }catch{}
    try{ if(await tryToncenter()) return true; }catch{}
    await new Promise(r=>setTimeout(r,pollEvery));
  }
  return false;
}

/* USDT — verifica on-chain con tx.wait() */
async function payUSDT(t,i){
  if(!evmSigner){alert('Connetti un wallet EVM (Connect Wallet)');return}
  const chainId=Number(evmChain), token=USDT[chainId], to=(RECIPIENT_EVM&&RECIPIENT_EVM[chainId])||null;
  if(!token||!to){alert('USDT non configurato per questa chain');return}
  const abi=["function transfer(address to,uint value) returns(bool)","function decimals() view returns(uint8)"];
  const c=new ethers.Contract(token,abi,evmSigner); const dec=Number(await c.decimals());
  const units=priceToUnits(t.prices.usdt||0, dec);
  const tx=await c.transfer(to,units); await tx.wait(); alert('USDT pagato (confermato) ✅'); unlock(i);
}

/* Boot */
if(!MODE_ADMIN){
  const cid=CHAT_QUERY;
  if(!cid){qs('storeMsg').style.display='block'; qs('storeMsg').textContent='Aggiungi ?chat_id=... all’URL (lo trovi nell’admin)';}
  else {renderStore(cid)}
}else{ updateLinksUI(); }
</script>
</body>
</html>
