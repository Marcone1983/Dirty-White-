<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dirty White Sh*t — Store</title>
<link rel="preconnect" href="https://unpkg.com">
<script src="https://unpkg.com/@tonconnect/ui@latest"></script>
<script src="https://unpkg.com/ethers@6.13.2/dist/ethers.min.js"></script>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https://unpkg.com; img-src 'self' data: https:; media-src 'self' data: https:; script-src 'self' https://unpkg.com 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://tonapi.io https://toncenter.com">
<style>
:root{--bg:#050907;--ink:#e7fdf2;--panel:#0b0f0d;--accent:#19ff9d}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(80% 100% at 10% 10%, #06110b, #010302),url('bg.jpg');background-size:cover;background-attachment:fixed;color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
.container{max-width:1100px;margin:0 auto;padding:18px}
.header{display:flex;align-items:center;gap:14px;margin:16px 0 10px;flex-wrap:wrap}
.logo{height:58px;filter:drop-shadow(0 6px 24px #00ff9955)}
h1{margin:0;font-size:28px}
.card{background:linear-gradient(180deg,#0e1512,#080d0b);border:1px solid #0f2018;border-radius:18px;padding:18px;box-shadow:0 10px 40px #000 inset,0 8px 30px #001f1233}
.btn{background:var(--accent);color:#001b0a;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.secondary{background:#0e1612;border:1px solid #123a2a;color:#caffed}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.item{background:#0a110e;border:1px solid #103726;border-radius:16px;overflow:hidden}
.item img{width:100%;height:180px;object-fit:cover}
.item .meta{padding:12px}
.badge{display:inline-block;background:#07231a;color:#9afdd7;border:1px solid #0b7a53;border-radius:10px;padding:2px 8px;font-size:12px;margin-right:6px}
.hidden{display:none}
small.muted{opacity:.72}
.status{margin-top:8px;font-size:13px}
footer{opacity:.7;margin-top:18px;font-size:12px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <img class="logo" src="logo-dirtywhite.png" alt="logo">
    <div>
      <h1 id="siteTitle">Dirty White Sh*t — Store</h1>
      <small class="muted">Preview 30s • Stars / TON / USDT • Download via Telegram</small>
    </div>
    <span style="flex:1"></span>
    <button class="btn" id="connect">CONNECT WALLETS</button>
  </div>

  <div id="heroWrap" class="card hidden" style="margin-bottom:14px">
    <img id="heroImg" src="" alt="hero" style="width:100%;max-height:260px;object-fit:cover;border-radius:12px">
  </div>

  <div id="grid" class="grid"></div>
  <div class="card hidden" id="msg"></div>

  <footer>Dirty White © All rights reserved</footer>
</div>

<script>
const CATALOG_URL='public-catalog.json';
const tonUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: 'tonconnect-manifest.json' });
let evmProvider=null, evmSigner=null, evmChain=null;

const qs=id=>document.getElementById(id);
const show=el=>el.classList.remove('hidden');
function txt(t){const s=document.createElement('span'); s.textContent=String(t||''); return s;}

qs('connect').onclick=async()=>{
  try{ if(window.ethereum){ await window.ethereum.request({method:'eth_requestAccounts'}); evmProvider=new ethers.BrowserProvider(window.ethereum); evmSigner=await evmProvider.getSigner(); evmChain=(await evmProvider.getNetwork()).chainId; } }catch{}
  try{ if(!tonUI.connected){ await tonUI.connectWallet(); } }catch{}
  alert('Wallet collegati.');
};

(async function boot(){
  try{
    const r=await fetch(CATALOG_URL,{cache:'no-store'}); if(!r.ok) throw new Error('Catalogo non trovato');
    const cat=await r.json();
    if(cat.brand?.title) qs('siteTitle').textContent=cat.brand.title;
    if(cat.brand?.hero_url){ show(qs('heroWrap')); qs('heroImg').src=cat.brand.hero_url; }
    render(cat);
  }catch(e){ const m=qs('msg'); show(m); m.textContent='⚠️ '+(e.message||'Errore catalogo'); }
})();

function render(cat){
  const grid=qs('grid'); grid.innerHTML='';
  if(!Array.isArray(cat.tracks)||!cat.tracks.length){ const m=qs('msg'); show(m); m.textContent='⚠️ Nessuna traccia'; return; }

  cat.tracks.forEach((t,i)=>{
    const card=document.createElement('div'); card.className='item';
    const img=document.createElement('img'); img.src=t.cover_url; img.alt='cover';
    const meta=document.createElement('div'); meta.className='meta';
    const title=document.createElement('div'); const strong=document.createElement('strong'); strong.textContent=String(t.title||''); title.appendChild(strong);
    const prices=document.createElement('div');
    ['Stars: '+(t.prices?.stars||0),'USDT: $'+(t.prices?.usdt||0),'TON: '+(t.prices?.ton||0)].forEach(x=>{const b=document.createElement('span'); b.className='badge'; b.textContent=x; prices.append(b);});
    const audio=document.createElement('audio'); audio.controls=true; audio.src=t.preview_url; audio.preload='metadata';
    audio.addEventListener('timeupdate',()=>{ if(!audio.dataset.unlocked && audio.currentTime>29.8){ audio.pause(); audio.currentTime=0; alert('Preview 30s'); }});
    const row=document.createElement('div'); row.style.marginTop='8px';

    const stars=document.createElement('a'); stars.className='btn'; stars.textContent='Buy Stars'; stars.target='_blank';
    stars.href=t.stars_link; stars.onclick=()=>setTimeout(()=>unlock(i),800);

    const tonBtn=document.createElement('button'); tonBtn.className='btn secondary'; tonBtn.textContent='Buy TON';
    tonBtn.onclick=()=>payTon(cat,t,i);

    const usdtBtn=document.createElement('button'); usdtBtn.className='btn secondary'; usdtBtn.textContent='Buy USDT';
    usdtBtn.style.marginLeft='6px'; tonBtn.style.marginLeft='6px';
    usdtBtn.onclick=()=>payUSDT(cat,t,i);

    const claim=document.createElement('a'); claim.className='btn'; claim.id='claim'+i; claim.style.display='none'; claim.textContent='Claim in Telegram';
    claim.href=t.claim_link; claim.target='_blank';

    row.append(stars,tonBtn,usdtBtn,claim);
    meta.append(title,prices,audio,row); card.append(img,meta); grid.append(card);
  });
}
function unlock(i){ const c=qs('claim'+i); if(c) c.style.display='inline-block'; }

// TON: invio + verifica on-chain (pubblica)
async function payTon(cat,t,i){
  try{
    if(!tonUI.connected) await tonUI.connectWallet();
    const to = cat.wallets?.ton; if(!to){ alert('TON non configurato'); return; }
    const amountNano = String(Math.round(Number(t.prices?.ton||0)*1e9));
    const validUntil = Math.floor(Date.now()/1000)+600;
    await tonUI.sendTransaction({ validUntil, messages:[{ address: to, amount: amountNano }] });

    const from = tonUI.account?.address;
    const ok = await verifyTon(from,to,BigInt(amountNano),Date.now());
    if(ok){ alert('TON pagato ✅ — fai Claim in Telegram'); unlock(i); } else { alert('Tx TON non trovata (attendi e riprova)'); }
  }catch(e){ alert(e?.message||e); }
}
async function verifyTon(fromAddr,toAddr,amountNano,startMs){
  const until=Date.now()+120000, eq=(a,b)=>String(a).replace(/[^A-Za-z0-9:_-]/g,'')===String(b).replace(/[^A-Za-z0-9:_-]/g,'');
  async function tryTonApi(){ try{ const r=await fetch(`https://tonapi.io/v2/address/${encodeURIComponent(fromAddr)}/transactions?limit=20`); if(!r.ok) return false; const j=await r.json(); const txs=j.transactions||j||[]; for(const tx of txs){ const outs=tx.out_msgs||tx.outMsgs||tx.messages||[]; for(const m of outs){ const d=(m.destination||m.dst||m.address||"").trim(); const v=BigInt(m.value||m.amount||m.nano||0); const ts=(tx.utime||tx.now||tx.timestamp||0)*1000; if(eq(d,toAddr)&&v===amountNano&&ts>=startMs-15000) return true; } } return false; }catch{return false} }
  async function tryToncenter(){ try{ const r=await fetch(`https://toncenter.com/api/v2/getTransactions?address=${encodeURIComponent(fromAddr)}&limit=20`); if(!r.ok) return false; const j=await r.json(); const txs=j.result||[]; for(const tx of txs){ const outs=tx.out_msgs||[]; for(const m of outs){ const d=(m.destination||"").trim(); const v=BigInt(m.value||0); const ts=(tx.utime||0)*1000; if(eq(d,toAddr)&&v===amountNano&&ts>=startMs-15000) return true; } } return false; }catch{return false} }
  while(Date.now()<until){ if(await tryTonApi()) return true; if(await tryToncenter()) return true; await new Promise(r=>setTimeout(r,4000)); } return false;
}

// USDT: trasferimento on-chain (il bot verificherà la tx su claim)
async function payUSDT(cat,t,i){
  try{
    if(!window.ethereum) { alert('Apri con un wallet EVM'); return; }
    await window.ethereum.request({method:'eth_requestAccounts'}); const prov=new ethers.BrowserProvider(window.ethereum); const signer=await prov.getSigner(); const chain=(await prov.getNetwork()).chainId;
    const tokenByChain={1:'0xdAC17F9...',137:'0xc2132D0...',56:'0x55d3983...'}; const token=USDT[Number(chain)];
    if(!token){ alert('Chain non supportata'); return; }
    const to = cat.wallets?.evm?.[String(Number(chain))]; if(!to){ alert('Destinatario USDT non configurato'); return; }
    const abi=["function transfer(address to,uint value) returns(bool)","function decimals() view returns(uint8)"];
    const c=new ethers.Contract(token,abi,signer); const dec=Number(await c.decimals());
    const amount=toUnits(t.prices?.usdt||0,dec); const tx=await c.transfer(to,amount); await tx.wait();
    alert('USDT pagato ✅ — fai Claim in Telegram'); unlock(i);
  }catch(e){ alert(e?.message||e); }
}
function toUnits(a,d){ const s=String(a||0); if(!s.includes('.')) return BigInt(s)*(10n**BigInt(d)); const [i,f]=s.split('.'); const frac=(f+'0'.repeat(d)).slice(0,d); return BigInt(i||'0')*(10n**BigInt(d))+BigInt(frac||'0'); }
</script>
</body>
</html>
