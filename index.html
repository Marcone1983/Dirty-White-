<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Music Store</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Stili per un'interfaccia pulita e moderna, adattata al tema di Telegram */
        :root {
            --tg-theme-bg-color: var(--tg-theme-bg-color, #ffffff);
            --tg-theme-text-color: var(--tg-theme-text-color, #000000);
            --tg-theme-hint-color: var(--tg-theme-hint-color, #999999);
            --tg-theme-link-color: var(--tg-theme-link-color, #2481cc);
            --tg-theme-button-color: var(--tg-theme-button-color, #2481cc);
            --tg-theme-button-text-color: var(--tg-theme-button-text-color, #ffffff);
            --tg-theme-secondary-bg-color: var(--tg-theme-secondary-bg-color, #f1f1f1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            padding: 15px;
            padding-bottom: 80px;
        }

        .container { 
            max-width: 600px; 
            margin: 0 auto; 
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--tg-theme-hint-color);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .content {
            display: none;
        }

        .content.active {
            display: block;
        }

        .track-card {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }

        .track-card:hover {
            transform: translateY(-2px);
        }

        .track-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .track-cover {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin-right: 15px;
        }

        .track-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .track-info p {
            color: var(--tg-theme-hint-color);
            font-size: 14px;
        }

        .track-prices {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .price-tag {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .buy-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 44px;
        }

        .btn-primary {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-text-color);
            border: 1px solid var(--tg-theme-hint-color);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .form-section {
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--tg-theme-text-color);
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 10px;
            font-size: 14px;
            background: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--tg-theme-button-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--tg-theme-secondary-bg-color);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--tg-theme-hint-color);
        }

        .empty-state .emoji {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color);
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 15px 25px;
            border-radius: 25px;
            z-index: 1000;
            display: none;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .notification.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .bottom-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-bg-color);
            border-top: 1px solid rgba(0,0,0,0.1);
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .main-action-btn {
            width: 100%;
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }

        .admin-badge {
            background: #ff6b6b;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Responsive design */
        @media (max-width: 480px) {
            .buy-buttons {
                flex-direction: column;
            }
            
            .track-prices {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üéµ Music Store</h1>
            <p id="welcomeMsg">Benvenuto nel tuo store musicale!</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="store">üõí Store</button>
            <button class="tab" data-tab="admin" id="adminTab" style="display: none;">‚öôÔ∏è Admin</button>
            <button class="tab" data-tab="stats">üìä Stats</button>
        </div>

        <!-- Store Content -->
        <div class="content active" id="store">
            <div id="trackList">
                <div class="loading">üéµ Caricamento tracce...</div>
            </div>
        </div>

        <!-- Admin Content -->
        <div class="content" id="admin">
            <div class="form-section">
                <h2>üì§ Aggiungi Nuova Traccia</h2>
                
                <div class="form-group">
                    <label for="trackTitle">üéµ Titolo</label>
                    <input type="text" id="trackTitle" placeholder="Es. My Awesome Song">
                </div>
                
                <div class="form-group">
                    <label for="trackDesc">üìù Descrizione</label>
                    <textarea id="trackDesc" rows="3" placeholder="Breve descrizione del brano"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="trackPrice">‚≠ê Prezzo in Telegram Stars</label>
                    <input type="number" id="trackPrice" placeholder="Es. 5" min="1" value="3">
                </div>
                
                <div class="form-group">
                    <label for="trackPriceUSDT">üíµ Prezzo in USDT</label>
                    <input type="number" id="trackPriceUSDT" placeholder="Es. 3.00" min="0.01" step="0.01" value="3.00">
                </div>
                
                <div class="form-group">
                    <label for="trackPriceTON">üíé Prezzo in TON</label>
                    <input type="number" id="trackPriceTON" placeholder="Es. 0.5" min="0.001" step="0.001" value="0.5">
                </div>
                
                <div class="form-group">
                    <label for="trackFileId">üéß File ID (carica prima il file audio nel bot)</label>
                    <input type="text" id="trackFileId" placeholder="BAADBAADrwADBREAAcaXBwABjJaOVgABAg">
                </div>
                
                <button class="btn btn-primary" style="width: 100%;" onclick="saveTrack()">
                    üíæ Salva Traccia
                </button>
            </div>

            <div class="form-section">
                <h2>üîß Configurazioni</h2>
                
                <div class="form-group">
                    <label for="walletTON">üíé Wallet TON</label>
                    <input type="text" id="walletTON" placeholder="UQArbhbVEIkN4xSWis30yIrNGdmOTBbiMBduGeNTErPbviyR">
                </div>
                
                <div class="form-group">
                    <label for="walletUSDT">üíµ Wallet USDT (ETH/BSC/TRON)</label>
                    <input type="text" id="walletUSDT" placeholder="0x...">
                </div>
                
                <button class="btn btn-secondary" style="width: 100%;" onclick="saveSettings()">
                    üíæ Salva Configurazioni
                </button>
            </div>
        </div>

        <!-- Stats Content -->
        <div class="content" id="stats">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTracks">0</div>
                    <div class="stat-label">Tracce Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalSales">0</div>
                    <div class="stat-label">Vendite</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">0</div>
                    <div class="stat-label">Revenue (Stars)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="storageUsed">0</div>
                    <div class="stat-label">Storage (KB)</div>
                </div>
            </div>

            <div class="form-section">
                <h3>üîÑ Backup & Restore</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" onclick="exportData()">üì§ Esporta</button>
                    <button class="btn btn-secondary" onclick="importData()">üì• Importa</button>
                    <button class="btn btn-secondary" onclick="clearData()">üóëÔ∏è Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Actions -->
    <div class="bottom-actions">
        <button class="main-action-btn" id="mainActionBtn" onclick="performMainAction()">
            üéµ Apri Store
        </button>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // ==========================================
        // TELEGRAM WEB APP INITIALIZATION
        // ==========================================
        
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        
        // Configurazione admin - IMPORTANTE: Inserisci qui il tuo ID utente Telegram
        const ADMIN_IDS = [856208904]; // <-- ID Admin configurato
        
        let appState = {
            tracks: [],
            settings: {},
            stats: { sales: 0, revenue: 0 },
            currentUser: null,
            isAdmin: false
        };

        // ==========================================
        // CLOUD STORAGE WRAPPER
        // ==========================================
        
        const CloudStorage = {
            async setItem(key, value) {
                return new Promise((resolve, reject) => {
                    const data = typeof value === 'string' ? value : JSON.stringify(value);
                    tg.CloudStorage.setItem(key, data, (error, result) => {
                        if (error) reject(error);
                        else resolve(result);
                    });
                });
            },
            
            async getItem(key) {
                return new Promise((resolve, reject) => {
                    tg.CloudStorage.getItem(key, (error, result) => {
                        if (error) reject(error);
                        else {
                            try {
                                resolve(result ? JSON.parse(result) : null);
                            } catch {
                                resolve(result);
                            }
                        }
                    });
                });
            },
            
            async getKeys() {
                return new Promise((resolve, reject) => {
                    tg.CloudStorage.getKeys((error, keys) => {
                        if (error) reject(error);
                        else resolve(keys || []);
                    });
                });
            },
            
            async removeItem(key) {
                return new Promise((resolve, reject) => {
                    tg.CloudStorage.removeItem(key, (error, result) => {
                        if (error) reject(error);
                        else resolve(result);
                    });
                });
            }
        };

        // ==========================================
        // INITIALIZATION
        // ==========================================
        
        async function init() {
            try {
                // Imposta informazioni utente
                const user = tg.initDataUnsafe?.user;
                if (user) {
                    appState.currentUser = user;
                    appState.isAdmin = ADMIN_IDS.includes(user.id);
                    
                    document.getElementById('welcomeMsg').textContent = 
                        `Benvenuto, ${user.first_name}!${appState.isAdmin ? ' (Admin)' : ''}`;
                    
                    // Mostra tab admin se √® admin
                    if (appState.isAdmin) {
                        document.getElementById('adminTab').style.display = 'block';
                    }
                }
                
                // Carica impostazioni
                appState.settings = await CloudStorage.getItem('settings') || {};
                
                // Carica statistiche
                appState.stats = await CloudStorage.getItem('stats') || { sales: 0, revenue: 0 };
                
                // Carica tracce
                await loadTracks();
                
                // Aggiorna UI
                updateStats();
                setupEventListeners();
                
                showNotification('üéµ Store caricato con successo!', 'success');
                
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                showNotification('‚ùå Errore nel caricamento: ' + error.message, 'error');
            }
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    showTab(tab.dataset.tab);
                });
            });
            
            // Popolamento campi wallet se gi√† salvati
            if (appState.settings.walletTON) {
                document.getElementById('walletTON').value = appState.settings.walletTON;
            }
            if (appState.settings.walletUSDT) {
                document.getElementById('walletUSDT').value = appState.settings.walletUSDT;
            }
        }

        // ==========================================
        // UI FUNCTIONS
        // ==========================================
        
        function showTab(tabName) {
            // Aggiorna tabs
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tabName);
            });
            
            // Aggiorna contenuto
            document.querySelectorAll('.content').forEach(c => {
                c.classList.toggle('active', c.id === tabName);
            });
            
            // Aggiorna azione principale
            const mainBtn = document.getElementById('mainActionBtn');
            switch(tabName) {
                case 'store':
                    mainBtn.textContent = 'üéµ Ricarica Store';
                    mainBtn.onclick = () => loadTracks();
                    break;
                case 'admin':
                    mainBtn.textContent = 'üíæ Salva Traccia';
                    mainBtn.onclick = () => saveTrack();
                    break;
                case 'stats':
                    mainBtn.textContent = 'üîÑ Aggiorna Stats';
                    mainBtn.onclick = () => updateStats();
                    break;
            }
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification show';
            
            // Feedback aptico
            if (type === 'success') {
                tg.HapticFeedback.notificationOccurred('success');
            } else if (type === 'error') {
                tg.HapticFeedback.notificationOccurred('error');
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ==========================================
        // TRACK MANAGEMENT
        // ==========================================
        
        async function loadTracks() {
            try {
                const trackList = document.getElementById('trackList');
                trackList.innerHTML = '<div class="loading">üéµ Caricamento tracce...</div>';
                
                // Ottieni tutte le chiavi delle tracce
                const keys = await CloudStorage.getKeys();
                const trackKeys = keys.filter(k => k.startsWith('track_'));
                
                if (trackKeys.length === 0) {
                    trackList.innerHTML = `
                        <div class="empty-state">
                            <span class="emoji">üéµ</span>
                            <h3>Nessuna traccia disponibile</h3>
                            <p>Le tracce caricate appariranno qui</p>
                        </div>
                    `;
                    return;
                }
                
                // Carica tutte le tracce
                const tracks = [];
                for (const key of trackKeys) {
                    const track = await CloudStorage.getItem(key);
                    if (track) tracks.push(track);
                }
                
                appState.tracks = tracks.sort((a, b) => new Date(b.created) - new Date(a.created));
                renderTracks();
                
            } catch (error) {
                console.error('Errore caricamento tracce:', error);
                showNotification('‚ùå Errore nel caricamento delle tracce', 'error');
            }
        }
        
        function renderTracks() {
            const trackList = document.getElementById('trackList');
            
            if (appState.tracks.length === 0) {
                trackList.innerHTML = `
                    <div class="empty-state">
                        <span class="emoji">üéµ</span>
                        <h3>Nessuna traccia disponibile</h3>
                        <p>Carica la tua prima traccia per iniziare!</p>
                    </div>
                `;
                return;
            }
            
            trackList.innerHTML = appState.tracks.map(track => `
                <div class="track-card">
                    <div class="track-header">
                        <div class="track-cover">üéµ</div>
                        <div class="track-info">
                            <h3>${track.title}</h3>
                            <p>${track.description}</p>
                        </div>
                    </div>
                    
                    <div class="track-prices">
                        <span class="price-tag">‚≠ê ${track.priceStars} Stars</span>
                        <span class="price-tag">üíµ $${track.priceUSDT} USDT</span>
                        <span class="price-tag">üíé ${track.priceTON} TON</span>
                    </div>
                    
                    <div class="buy-buttons">
                        <button class="btn btn-primary" onclick="buyWithStars('${track.id}', ${track.priceStars})">
                            ‚≠ê Compra con Stars
                        </button>
                        <button class="btn btn-secondary" onclick="buyWithCrypto('${track.id}', 'USDT', ${track.priceUSDT})">
                            üíµ USDT
                        </button>
                        <button class="btn btn-secondary" onclick="buyWithCrypto('${track.id}', 'TON', ${track.priceTON})">
                            üíé TON
                        </button>
                    </div>
                    
                    ${appState.isAdmin ? `
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="deleteTrack('${track.id}')" style="background: #ff6b6b; color: white;">
                                üóëÔ∏è Elimina
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        async function saveTrack() {
            try {
                const title = document.getElementById('trackTitle').value.trim();
                const description = document.getElementById('trackDesc').value.trim();
                const priceStars = parseInt(document.getElementById('trackPrice').value) || 3;
                const priceUSDT = parseFloat(document.getElementById('trackPriceUSDT').value) || 3.0;
                const priceTON = parseFloat(document.getElementById('trackPriceTON').value) || 0.5;
                const fileId = document.getElementById('trackFileId').value.trim();
                
                if (!title || !description) {
                    showNotification('‚ùå Titolo e descrizione sono obbligatori', 'error');
                    return;
                }
                
                if (priceStars < 1) {
                    showNotification('‚ùå Il prezzo in Stars deve essere almeno 1', 'error');
                    return;
                }
                
                const trackId = `track_${Date.now()}`;
                const trackData = {
                    id: trackId,
                    title,
                    description,
                    priceStars,
                    priceUSDT,
                    priceTON,
                    fileId,
                    created: new Date().toISOString()
                };
                
                await CloudStorage.setItem(trackId, trackData);
                
                // Reset form
                document.getElementById('trackTitle').value = '';
                document.getElementById('trackDesc').value = '';
                document.getElementById('trackFileId').value = '';
                
                showNotification('‚úÖ Traccia salvata con successo!', 'success');
                
                // Ricarica tracce e vai al tab store
                await loadTracks();
                showTab('store');
                
            } catch (error) {
                console.error('Errore salvataggio traccia:', error);
                showNotification('‚ùå Errore nel salvataggio: ' + error.message, 'error');
            }
        }
        
        async function deleteTrack(trackId) {
            if (!confirm('Sei sicuro di voler eliminare questa traccia?')) return;
            
            try {
                await CloudStorage.removeItem(trackId);
                showNotification('‚úÖ Traccia eliminata', 'success');
                await loadTracks();
            } catch (error) {
                showNotification('‚ùå Errore nell\'eliminazione', 'error');
            }
        }

        // ==========================================
        // PAYMENT FUNCTIONS
        // ==========================================
        
        function buyWithStars(trackId, price) {
            const track = appState.tracks.find(t => t.id === trackId);
            if (!track) {
                showNotification('‚ùå Traccia non trovata', 'error');
                return;
            }
            
            // Crea invoice per Telegram Stars
            const invoiceData = {
                title: `üéµ ${track.title}`,
                description: `Acquista "${track.title}" per ${price} Telegram Stars`,
                payload: JSON.stringify({
                    trackId: trackId,
                    userId: appState.currentUser?.id,
                    method: 'stars'
                }),
                prices: [{ label: track.title, amount: price }]
            };
            
            // Invia dati al bot per creare l'invoice
            tg.sendData(JSON.stringify({
                action: 'create_stars_invoice',
                invoice: invoiceData
            }));
            
            showNotification('üí´ Creazione pagamento Stars...', 'success');
        }
        
        function buyWithCrypto(trackId, currency, price) {
            const track = appState.tracks.find(t => t.id === trackId);
            if (!track) {
                showNotification('‚ùå Traccia non trovata', 'error');
                return;
            }
            
            let walletAddress;
            if (currency === 'TON') {
                walletAddress = appState.settings.walletTON || 'UQArbhbVEIkN4xSWis30yIrNGdmOTBbiMBduGeNTErPbviyR';
            } else if (currency === 'USDT') {
                walletAddress = appState.settings.walletUSDT || '0x742d35Cc6634C0532925a3b8D0C9e3e4C8b8e8e8';
            }
            
            const message = `üí∞ **Pagamento ${currency}**\\n\\n` +
                           `üéµ Traccia: ${track.title}\\n` +
                           `üíµ Prezzo: ${price} ${currency}\\n` +
                           `üìç Wallet: \`${walletAddress}\`\\n\\n` +
                           `üìù **Istruzioni:**\\n` +
                           `1. Invia esattamente ${price} ${currency}\\n` +
                           `2. All'indirizzo sopra\\n` +
                           `3. Inoltra la ricevuta di pagamento\\n` +
                           `4. Riceverai il file entro 24h\\n\\n` +
                           `‚ö†Ô∏è **Importante:** Usa la rete corretta per USDT (ETH/BSC/TRON)`;
            
            tg.showPopup({
                title: `Pagamento ${currency}`,
                message: message,
                buttons: [
                    { id: 'copy', type: 'default', text: 'Copia Wallet' },
                    { id: 'close', type: 'cancel', text: 'Chiudi' }
                ]
            }, (buttonId) => {
                if (buttonId === 'copy') {
                    navigator.clipboard.writeText(walletAddress);
                    showNotification('üìã Wallet copiato negli appunti!', 'success');
                }
            });
        }

        // ==========================================
        // SETTINGS & STATS
        // ==========================================
        
        async function saveSettings() {
            try {
                const settings = {
                    walletTON: document.getElementById('walletTON').value.trim(),
                    walletUSDT: document.getElementById('walletUSDT').value.trim()
                };
                
                await CloudStorage.setItem('settings', settings);
                appState.settings = settings;
                
                showNotification('‚úÖ Configurazioni salvate!', 'success');
                
            } catch (error) {
                console.error('Errore salvataggio impostazioni:', error);
                showNotification('‚ùå Errore nel salvataggio', 'error');
            }
        }
        
        async function updateStats() {
            try {
                const keys = await CloudStorage.getKeys();
                const trackKeys = keys.filter(k => k.startsWith('track_'));
                const salesKeys = keys.filter(k => k.startsWith('sale_'));
                
                // Calcola storage utilizzato (approssimativo)
                let storageUsed = 0;
                for (const key of keys) {
                    const item = await CloudStorage.getItem(key);
                    if (item) {
                        storageUsed += JSON.stringify(item).length;
                    }
                }
                
                document.getElementById('totalTracks').textContent = trackKeys.length;
                document.getElementById('totalSales').textContent = salesKeys.length;
                document.getElementById('totalRevenue').textContent = appState.stats.revenue || 0;
                document.getElementById('storageUsed').textContent = Math.round(storageUsed / 1024);
                
            } catch (error) {
                console.error('Errore aggiornamento statistiche:', error);
            }
        }
        
        async function exportData() {
            try {
                const keys = await CloudStorage.getKeys();
                const data = {};
                
                for (const key of keys) {
                    data[key] = await CloudStorage.getItem(key);
                }
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-store-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                showNotification('üì§ Backup esportato!', 'success');
                
            } catch (error) {
                showNotification('‚ùå Errore nell\'esportazione', 'error');
            }
        }
        
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                try {
                    const file = e.target.files[0];
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    for (const [key, value] of Object.entries(data)) {
                        await CloudStorage.setItem(key, value);
                    }
                    
                    showNotification('üì• Dati importati con successo!', 'success');
                    await loadTracks();
                    updateStats();
                    
                } catch (error) {
                    showNotification('‚ùå Errore nell\'importazione', 'error');
                }
            };
            input.click();
        }
        
        async function clearData() {
            if (!confirm('‚ö†Ô∏è ATTENZIONE: Questa azione eliminer√† TUTTI i dati. Sei sicuro?')) return;
            
            try {
                const keys = await CloudStorage.getKeys();
                for (const key of keys) {
                    await CloudStorage.removeItem(key);
                }
                
                showNotification('üóëÔ∏è Tutti i dati sono stati eliminati', 'success');
                await loadTracks();
                updateStats();
                
            } catch (error) {
                showNotification('‚ùå Errore nella cancellazione', 'error');
            }
        }
        
        function performMainAction() {
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            switch(activeTab) {
                case 'store':
                    loadTracks();
                    break;
                case 'admin':
                    saveTrack();
                    break;
                case 'stats':
                    updateStats();
                    break;
            }
        }

        // ==========================================
        // START APPLICATION
        // ==========================================
        
        // Avvia l'applicazione quando la pagina √® caricata
        document.addEventListener('DOMContentLoaded', init);
        
        // Gestisci il back button di Telegram
        tg.BackButton.onClick(() => {
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            if (activeTab !== 'store') {
                showTab('store');
            } else {
                tg.close();
            }
        });
        
        // Mostra il back button quando non si √® nel tab store
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab')) {
                const tabName = e.target.dataset.tab;
                if (tabName === 'store') {
                    tg.BackButton.hide();
                } else {
                    tg.BackButton.show();
                }
            }
        });
        
    </script>
</body>
</html>
